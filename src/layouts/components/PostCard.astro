---
import { Image } from "astro:assets";
import config from "@/config/config.json";
import { Card as ShadcnCard, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import dateFormat from "@/lib/utils/dateFormat";
import { plainify, humanize, slugify } from "@/lib/utils/textConverter";
import { BiCalendarEdit } from "react-icons/bi";

const { summary_length } = config.settings;
const rawCategoryImages = config.settings.category_images || {};
const { post } = Astro.props;
const defaultGeneratedImageBase = "https://honyadizu.imgix.net/exp-cards-title-bg.jpg";

const categoryImageMap = Object.entries(rawCategoryImages).reduce(
  (acc, [key, value]) => {
    if (!value) {
      return acc;
    }
    acc[key] = value;
    const slugKey = slugify(key);
    if (slugKey && !acc[slugKey]) {
      acc[slugKey] = value;
    }
    return acc;
  },
  {} as Record<string, string>,
);

const buildGeneratedImage = (title: string) =>
  `${defaultGeneratedImageBase}?txt=${encodeURIComponent(title || "post")}&txt-size=80&txt-pad=36&txt-shad=5&txt-fit=max&txt-align=center,middle&blur=30&txt-color=fff&w=445&h=230&fm=webp&q=85`;

const defaultCategoryImage = categoryImageMap.default || config.metadata?.meta_image;

const categoryImage = (() => {
  const categories = post.data.categories || [];
  for (const category of categories) {
    const slug = slugify(category);
    if (slug && categoryImageMap[slug]) {
      return categoryImageMap[slug];
    }
    if (categoryImageMap[category]) {
      return categoryImageMap[category];
    }
  }
  return null;
})();

const postImage = typeof post.data.image === "string" ? post.data.image.trim() : "";
const fallbackImage = defaultCategoryImage || buildGeneratedImage(post.data.title);
const imageSrc = postImage || categoryImage || fallbackImage;
// Local SVG placeholders can't be processed by astro:assets, so fall back to a native <img>.
const useBasicImg = typeof imageSrc === "string" && (imageSrc.startsWith("/") || imageSrc.endsWith(".svg"));
---

<article class="group">
  <ShadcnCard className="h-full transition-all duration-300 hover:shadow-xl hover:border-primary/50 overflow-hidden" client:visible>
    <a href={`/entry/${post.id}`} class="block">
      <div class="relative overflow-hidden aspect-video">
        {useBasicImg ? (
          <img
            class="object-cover w-full h-full group-hover:scale-105 transition duration-500"
            src={imageSrc}
            alt={post.data.title}
            width="445"
            height="230"
            loading="lazy"
          />
        ) : (
          <Image
            class="object-cover w-full h-full group-hover:scale-105 transition duration-500"
            src={imageSrc}
            alt={post.data.title}
            width="445"
            height="230"
            loading="lazy"
          />
        )}
        
        {(post.data.tags || post.data.tag) && (post.data.tags?.length > 0 || post.data.tag?.length > 0) && (
          <div class="absolute bottom-2 left-2 flex flex-wrap gap-1">
            {(post.data.tags || post.data.tag || []).slice(0, 3).map((tag: string) => (
              <Badge 
                variant="secondary" 
                className="text-xs px-2 py-0.5 bg-black/60 text-white border-none backdrop-blur-sm" 
                client:visible
              >
                {humanize(tag)}
              </Badge>
            ))}
          </div>
        )}
      </div>
      
      <CardHeader className="space-y-2 px-6 pt-4 pb-2">
        <CardTitle className="text-base md:text-lg line-clamp-2 group-hover:text-primary transition-colors">
          {post.data.title}
        </CardTitle>
        
        <CardDescription className="flex items-center text-xs text-muted-foreground">
          <BiCalendarEdit className="mr-1 h-3.5 w-3.5" />
          {dateFormat(post.data.date)}
        </CardDescription>
      </CardHeader>
      
      <CardContent className="pt-0">
        <p class="text-sm text-muted-foreground line-clamp-2">
          {plainify(post.body?.slice(0, Number(summary_length)))}
        </p>
      </CardContent>
    </a>
  </ShadcnCard>
</article>
