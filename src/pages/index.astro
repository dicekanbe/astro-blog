---
import config from "@/config/config.json";
import Base from "@/layouts/Base.astro";
import Pagination from "@/layouts/components/Pagination.astro";
import Posts from "@/layouts/Posts.astro";
import HorizontalPosts from "@/layouts/HorizontalPosts.astro";
import { HorizontalScroll } from "@/components/ui/HorizontalScroll";
import { getSinglePage } from "@/lib/contentParser.astro";
import { getTaxonomy } from "@/lib/taxonomyParser.astro";
import { sortByDate } from "@/lib/utils/sortFunctions";
import { humanize, slugify } from "@/lib/utils/textConverter";

const posts = await getSinglePage("posts");
const sortedPosts = sortByDate(posts);

// カテゴリーごとに記事をグループ化
const categories = await getTaxonomy("posts", "categories");
const categoryGroups = new Map();

// 表示するカテゴリーのリスト（日本語）
const categoryOrder: string[] = config.settings.category_order || [];

// すべてのカテゴリーで記事を集める
for (const category of categories) {
  const categoryPosts = sortedPosts.filter((post: any) => 
    post.data.categories?.some((cat: string) => slugify(cat) === category)
  );
  if (categoryPosts.length > 0) {
    categoryGroups.set(category, categoryPosts);
  }
}

// categoryOrderの日本語名とslugifyされたカテゴリー名をマッピング
const sortedCategories = categoryOrder
  .map(cat => slugify(cat))
  .filter(slugifiedCat => categoryGroups.has(slugifiedCat));

// 最新記事（すべてのカテゴリーから）
const latestPosts = sortedPosts.slice(0, 20);
---

<Base>
  <!-- Latest Posts Section -->
  <section class="py-6 md:py-8 border-b">
    <div class="container mx-auto px-4 md:px-6 lg:px-8 max-w-[2000px]">
      <div class="mb-4 flex items-center justify-between">
        <div>
          <h2 class="text-3xl font-bold tracking-tight mb-2">新着<span class="text-muted-foreground font-normal ml-2">New</span></h2>
          <div class="h-1 w-20 bg-primary rounded-full"></div>
        </div>
        <a href="/page/1" class="text-sm font-medium text-muted-foreground hover:text-primary transition-colors flex items-center gap-1">
          すべて見る
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
      </div>
      
      <HorizontalScroll client:load>
        <HorizontalPosts posts={latestPosts} />
      </HorizontalScroll>
    </div>
  </section>

  <!-- Category Sections -->
  {
    sortedCategories.map((category) => (
      <section class="py-6 md:py-8 border-b">
        <div class="container mx-auto px-4 md:px-6 lg:px-8 max-w-[2000px]">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-2xl md:text-3xl font-bold tracking-tight mb-2">
                {humanize(category)}
              </h2>
              <div class="h-1 w-16 bg-primary rounded-full"></div>
            </div>
            <a 
              href={`/categories/${category}`}
              class="text-sm font-medium text-muted-foreground hover:text-primary transition-colors flex items-center gap-1"
            >
              もっと見る
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          </div>
          
          <HorizontalScroll client:load>
            <HorizontalPosts posts={categoryGroups.get(category).slice(0, 20)} />
          </HorizontalScroll>
        </div>
      </section>
    ))
  }
</Base>
